<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dot-to-Dot: Farm</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../style/style.css"> <!-- Shared stylesheet -->
    <style>
        body {
   	    height: auto;
	    overflow-y: auto;
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }

        /* Game container to stack image, canvas, and dots */
        #game-container {
            position: relative;
            width: 100%;
            /* Aspect ratio based on a typical image, e.g., 4:3 */
            aspect-ratio: 4 / 3; 
            max-width: 800px; /* Max size of the game */
            margin: auto;
            border: 2px solid #ccc;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        #game-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Make image transparent so dots are clear */
            opacity: 0; 
            transition: opacity 1s ease-in-out;
        }

        #game-container img.finished {
            opacity: 1; /* Show image when done */
        }

        #dot-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #dot-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

/* --- Make Farm dots look like T-Rex dots --- */
.dot {
  position: absolute;
  width: 32px;
  height: 32px;
  background-color: #4F46E5;   /* indigo fill like trex .dot-circle */
  border: 4px solid #FFFFFF;   /* white stroke like trex */
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 600;
  color: #FFFFFF;              /* white label like trex .dot-label */
  cursor: pointer;
  transform: translate(-50%, -50%);
  transition: transform 0.2s ease;
  user-select: none;
}

.dot:hover {
  transform: translate(-50%, -50%) scale(1.06);
}

/* highlight next dot (trex: .dot-circle-next = emerald) */
.dot.next-dot {
  background-color: #10B981;   /* emerald */
  border-color: #FFFFFF;
  box-shadow: none;            /* remove lime glow from old style */
}

/* completed dot (trex greys it out) */
.dot.completed {
  background-color: #9CA3AF;   /* gray-400 */
  border-color: #FFFFFF;
  color: #E5E7EB;              /* gray-200 label */
  opacity: 1;                  /* match trex (no extra fade) */
  pointer-events: none;
}

        .game-shake {
            animation: gameShake 0.3s ease-in-out;
        }

        @keyframes gameShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Win Overlay (from concentration game) */
        .win-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .win-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .win-message {
            color: white;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <main class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
        <!-- Header -->
        <header class="flex flex-wrap items-center justify-between gap-4 mb-6 pb-4 border-b">
            <a href="index.html" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-sm hover:bg-gray-300 transition">&larr; Back to Dot-to-Dot</a>
            <h1 class="text-2xl font-bold text-gray-800">Farm</h1>
        </header>

        <!-- Controls -->
        <div id="controls" class="flex flex-wrap items-center justify-center gap-6 mb-6">
            <span class="font-semibold text-lg">Count by:</span>
            <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer text-lg">
                    <input type="radio" name="increment" value="1" class="form-radio h-5 w-5 text-blue-600" checked>
                    1s
                </label>
                <label class="flex items-center gap-2 cursor-pointer text-lg">
                    <input type="radio" name="increment" value="2" class="form-radio h-5 w-5 text-blue-600">
                    2s
                </label>
                <label class="flex items-center gap-2 cursor-pointer text-lg">
                    <input type="radio" name="increment" value="5" class="form-radio h-5 w-5 text-blue-600">
                    5s
                </label>
                <label class="flex items-center gap-2 cursor-pointer text-lg">
                    <input type="radio" name="increment" value="10" class="form-radio h-5 w-5 text-blue-600">
                    10s
                </label>
            </div>
        </div>
        
        <!-- Game Board -->
        <div id="game-container">
            <img id="background-image" src="images/farm.png" alt="Farm scene">
            <canvas id="dot-canvas"></canvas>
            <div id="dot-container"></div>
        </div>
    </main>

    <!-- Win Overlay -->
    <div id="win-overlay" class="win-overlay">
        <div class="win-message">You Did It!</div>
        <div class="mt-8 flex flex-col sm:flex-row gap-4">
            <button id="play-again-btn" class="px-8 py-4 bg-emerald-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-emerald-700 transition">Play Again</button>
            <a href="index.html" class="px-8 py-4 bg-gray-200 text-gray-800 font-semibold text-lg rounded-lg shadow-sm hover:bg-gray-300 transition text-center">More Games</a>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="click-sound" src="../sounds/flip.mp3" preload="auto"></audio>
    <audio id="win-sound" src="../sounds/win.mp3" preload="auto"></audio>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Game Data ---
            // Coordinates for 20 dots (as percentages)
            const farmDots = [
                { x: 20, y: 80 }, { x: 30, y: 80 }, { x: 40, y: 80 }, { x: 40, y: 65 },
                { x: 45, y: 60 }, { x: 55, y: 60 }, { x: 60, y: 65 }, { x: 60, y: 80 },
                { x: 70, y: 80 }, { x: 80, y: 80 }, { x: 80, y: 70 }, { x: 80, y: 55 },
                { x: 85, y: 50 }, { x: 70, y: 35 }, { x: 50, y: 20 }, { x: 30, y: 35 },
                { x: 15, y: 50 }, { x: 20, y: 55 }, { x: 20, y: 70 }, { x: 10, y: 80 } // Moved 20th dot left
            ];
            const dots = farmDots;

            // --- DOM Elements ---
            const gameContainer = document.getElementById('game-container');
            const dotContainer = document.getElementById('dot-container');
            const canvas = document.getElementById('dot-canvas');
            const ctx = canvas.getContext('2d');
            const bgImage = document.getElementById('background-image');
            const incrementRadios = document.querySelectorAll('input[name="increment"]');
            const winOverlay = document.getElementById('win-overlay');
            const playAgainBtn = document.getElementById('play-again-btn');

            // --- Audio Elements ---
            const clickSound = document.getElementById('click-sound');
            const winSound = document.getElementById('win-sound');

            // --- Game State ---
            let currentDotIndex = 0;
            let currentIncrement = 1;
            let lastPoint = null;
            let allDots = []; // To store references to the dot DOM elements
            let audioUnlocked = false;

            // --- Audio Functions ---
            function unlockAudio() {
                if (audioUnlocked) return;
                clickSound.play().then(() => {
                    clickSound.pause();
                }).catch(() => {});
                winSound.play().then(() => winSound.pause()).catch(() => {});
                audioUnlocked = true;
            }

            function playSound(sound) {
                if (sound && audioUnlocked) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log("Sound play failed:", e));
                }
            }
 
            // --- Haptic Feedback ---
            function triggerHapticFeedback() {
                if (navigator.vibrate) {
                    navigator.vibrate(100); // 100ms vibration
                }
            }

            // --- Game Logic ---
            function initGame() {
                // Get selected increment
                currentIncrement = parseInt(document.querySelector('input[name="increment"]:checked').value);
                
                // Reset state
                currentDotIndex = 0;
                lastPoint = null;
                allDots = [];
                dotContainer.innerHTML = '';
                bgImage.classList.remove('finished');
                winOverlay.classList.remove('show');
                
                // Resize canvas to match container
                if (gameContainer.clientWidth > 0 && gameContainer.clientHeight > 0) {
                    canvas.width = gameContainer.clientWidth;
                    canvas.height = gameContainer.clientHeight;
                } else {
                    // Fallback or wait for layout
                    setTimeout(initGame, 100); // Retry shortly
                    return;
                }
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.strokeStyle = '#4F46E5'; // match trex stroke
ctx.lineWidth = 5;           // match trex thickness
                
                drawDots();
                highlightNextDot();
            }

            function drawDots() {
                dots.forEach((dot, index) => {
                    const dotEl = document.createElement('div');
                    dotEl.classList.add('dot');
                    dotEl.style.left = `${dot.x}%`;
                    dotEl.style.top = `${dot.y}%`;
                    
                    // Calculate dot label
                    const label = (index + 1) * currentIncrement;
                    dotEl.textContent = label;
                    dotEl.dataset.index = index;
                    
                    dotEl.addEventListener('click', handleDotClick);
                    dotContainer.appendChild(dotEl);
                    allDots.push(dotEl);
                });
            }

            function highlightNextDot() {
                // Remove highlight from previous
                const prevHighlight = document.querySelector('.next-dot');
                if (prevHighlight) {
                    prevHighlight.classList.remove('next-dot');
                }
                
                // Add highlight to current
                if (currentDotIndex < allDots.length) {
                    allDots[currentDotIndex].classList.add('next-dot');
                }
            }

            function handleDotClick(e) {
                if (!audioUnlocked) {
                    unlockAudio();
                }
                playSound(clickSound); // Play click sound on any dot click

                const clickedIndex = parseInt(e.target.dataset.index);

                if (clickedIndex === currentDotIndex) {
                    // --- CORRECT DOT ---
                    const dotEl = allDots[clickedIndex];
                    dotEl.classList.remove('next-dot');
                    dotEl.classList.add('completed');
                    
                    // Get center of dot for drawing (in pixels)
                    const rect = dotEl.getBoundingClientRect();
                    const containerRect = gameContainer.getBoundingClientRect();
                    const currentPoint = {
                        x: rect.left - containerRect.left + rect.width / 2,
                        y: rect.top - containerRect.top + rect.height / 2
                    };

                    if (lastPoint) {
                        // Draw line from last point to this point
                        ctx.beginPath();
                        ctx.moveTo(lastPoint.x, lastPoint.y);
                        ctx.lineTo(currentPoint.x, currentPoint.y);
                        ctx.stroke();
                    }
                    lastPoint = currentPoint;
                    
                    currentDotIndex++;

                    if (currentDotIndex === dots.length) {
                        // --- GAME WON ---
                        // Draw final line back to start
                        const firstDotEl = allDots[0];
                        const firstRect = firstDotEl.getBoundingClientRect();
                        const firstPoint = {
                            x: firstRect.left - containerRect.left + firstRect.width / 2,
                            y: firstRect.top - containerRect.top + firstRect.height / 2
                        };
                        ctx.beginPath();
                        ctx.moveTo(lastPoint.x, lastPoint.y);
                        ctx.lineTo(firstPoint.x, firstPoint.y);
                        ctx.stroke();

                        winGame();
                    } else {
                        // Highlight the next dot
                        highlightNextDot();
                    }

                } else {
                    // --- WRONG DOT ---
                    gameContainer.classList.add('game-shake');
                    triggerHapticFeedback();
                    // Remove shake class after animation finishes
                    setTimeout(() => {
                        gameContainer.classList.remove('game-shake');
                    }, 300);
                }
            }

            function winGame() {
                playSound(winSound);
                bgImage.classList.add('finished'); // Show the final image
                winOverlay.classList.add('show');
            }
            
            // --- Resize Logic ---
            let resizeTimer;
            function handleResize() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    console.log("Resizing...");
                    initGame(); 
                }, 250); // Debounce resize event
            }

            // --- Event Listeners ---
            incrementRadios.forEach(radio => {
                radio.addEventListener('change', initGame);
            });

            playAgainBtn.addEventListener('click', initGame);

            // Redraw on resize to keep canvas and container dimensions in sync
            window.addEventListener('resize', handleResize);
            
            // Initial game setup
            // Use setTimeout to ensure container has dimensions
            setTimeout(initGame, 0);
        });
    </script>
</body>
</html>


